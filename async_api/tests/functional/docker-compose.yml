version: '3.9'

services:
  test_elasticsearch:
    image: elasticsearch:8.6.2
    container_name: test_elasticsearch
    ports:
      - "9200:9200"
    environment:
      - "discovery.type=single-node"
      - "xpack.security.enabled=false"
    env_file:
      - .env
    volumes:
      - test_es_data:/usr/share/elasticsearch/data

  test_cache:
    image: redis:7.2.3-alpine3.18
    container_name: test_cache
    env_file:
      - .env
    volumes:
      - test_cache:/data

  test_async_api:
    container_name: test_fastapi
    image: fastapi-image
    command: gunicorn main:app --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:7000
    env_file:
      - .env
    environment:
      PYTHONPATH: /app/src
      
    depends_on:
      - test_cache

  tests:
    image: fastapi-image
    env_file:
      - .env
    environment:
      PYTHONPATH: /app
      ES_HOST: ${ES_HOST}
      ES_INDEX: ${ES_INDEX}
      ES_ID_FIELD: ${ES_ID_FIELD}
      ES_PORT: ${ES_PORT}
      SERVICE_URL: ${SERVICE_URL}
      REDIS_HOST: ${REDIS_HOST}

    volumes:
      - ./async_api/tests:/tests/

    entrypoint: >
      sh -c "pip install -r tests/functional/requirements.txt
      && python3 tests/functional/utils/wait_for_es.py
      && python3 tests/functional/utils/wait_for_redis.py
      && pytest tests/functional/src"

volumes:
  test_es_data:
  test_cache:
